# LIMS_FILE_CLIENT

## 说明
1. 本客户端作为实验室管理系统中分布式文件下载部分的客户端（相对于主文件服务器，每个实验室一个文件服务器），同时可以作为其他客户端下载文件的服务器，由主服务器来协调
2. 传输文件时使用TCP  发送命令时用UDP

## 工作流程
1. 学生用手机LIMS客户端扫描本客户端生成的二维码（包含设备ID  设备类型  设备IP信息）
2. 手机端发送设备借入请求到服务器
3. 设备类型为 “电脑” 时
4. 服务器根据设备所在位置找到对应的文件服务器IP，根据实验项目查找本次实验需要的实验资料文件列表，并将文件列表和本次借出的设备IP发送到文件服务器。由此启动文件分发流程。

## 文件分发流程
1. 临时服务器以单个文件为单位
2. 主服务器记录已经接收完成某个客户端的列表 
```C++
//QString为某个文件名，QQueue*为一个队列指针，存储了已经接收完成该文件的客户端列表
//在ClientManagement中初始化该列表，包含FileManagement中的每个需要推送的文件名
//当有客户端报告完成接收某个文件时，即将其加入对应的队列
QMap<QString, QQueue*> serverFileMap;
```
3. 发送和接收均在子线程中进行
4. 当主服务器收到客户端的存活响应时，需要在该客户端对应的Client实例中存储目前仍需要推送的文件列表
```
//Client中需要推送的文件列表
//当该客户端报告完成接收某个文件时，即将该文件从列表中删除
QList<QString>
```
5. 当服务器得知某个客户端接收文件完成时，即进行服务器分配
6. 主服务器还需要记录需要某个文件的客户端列表，分配服务器时，遍历fileManagemengt中的文件列表，以表项作为键值，从clientFileMap和serverFileMap中取出对应的队列，当队列都不为空时，即从server队列中为client队列分配服务器。（暂时不考虑客户端发送线程的数量，即只要服务器下达命令，临时服务器就推送）
```C++
QMap<QString,QQueue*>clientFileMap;
```







~~1. 文件服务器根据实验项目建立推送列表，存储已经推送完成的客户端信息，这些客户端和主文件服务器构成本次实验的文件服务器
2. 为本次下载的客户端分配临时文件服务器，将客户端IP发送的该“服务器”
3. 临时服务器将文件推送到客户端~~


### 主服务器职责
1. 记录客户端信息
2. 维护文件列表
3. 向临时服务器下发推送命令
4. 向客户端推送文件

### 客户端职责
1. 接收服务器的文件
2. 充当临时服务器，向其他客户端推送文件
3. 当文件接收完毕时报告主服务器
